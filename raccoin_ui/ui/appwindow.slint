import { Button, CheckBox, ComboBox, GridBox, HorizontalBox, LineEdit, StandardButton, VerticalBox } from "std-widgets.slint";
import { Portfolio } from "portfolio.slint";
import { Wallets } from "wallets.slint";
import { Transactions } from "transactions.slint";
import { Reports } from "reports.slint";
import { Badge } from "common.slint";
import { Facade } from "global.slint";
import { UiCapitalGain, UiNotificationType } from "structs.slint";

export { UiCapitalGain, Facade }

enum Page {
    portfolio,
    sources,
    transactions,
    reports,
}

component PageButton inherits Rectangle {
    in property <string> text <=> txt.text;
    in property <bool> active;

    callback pressed;

    border-radius: self.height / 4;
    border-color: (touch.has-hover || root.active) ? #456 : #3e3e3e;
    border-width: 1px;
    background: root.active ? #456 : touch.has-hover ? #4564 : transparent;
    height: layout.preferred-height * 1.33;
    width: layout.preferred-width + 20px;

    layout := HorizontalLayout {
        spacing: 10px;
        alignment: center;
        txt := Text {
            font-size: 14px;
            vertical-alignment: center;
        }

        @children
    }
    touch := TouchArea {
        pointer-event(event) => {
            if (event.kind == PointerEventKind.down) {
                root.pressed();
            }
        }
    }
}

component NavigationBar inherits HorizontalBox {
    in-out property <Page> active-page;

    alignment: center;

    PageButton {
        text: "Portfolio";
        active: active-page == Page.portfolio;
        pressed => { root.active-page = Page.portfolio; }
    }
    PageButton {
        text: "Wallets";
        active: active-page == Page.sources;
        pressed => { root.active-page = Page.sources; }

        Badge {
            text: Facade.wallets.length;
        }
    }
    PageButton {
        text: "Transactions";
        active: active-page == Page.transactions;
        pressed => { root.active-page = Page.transactions; }

        Badge {
            text: Facade.transactions.length;
        }
    }
    PageButton {
        text: "Reports";
        active: active-page == Page.reports;
        pressed => { root.active-page = Page.reports; }

        Badge {
            text: Facade.reports.length;
        }
    }
}

component CloseButton inherits Rectangle {
    in property <image> icon: @image-url("icons/x.svg");

    callback clicked;

    width: 24px;
    height: 24px;
    border-radius: 4px;
    border-width: close-button-area.has-hover ? 1px : 0px;
    border-color: #3e3e3e;
    background: close-button-area.has-hover ? #4564 : transparent;

    Image {
        source: root.icon;
        width: 16px;
        height: 16px;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
    }

    close-button-area := TouchArea {
        width: 100%;
        height: 100%;
        clicked => { root.clicked(); }
    }
}

component ModalDialog inherits PopupWindow {
    in property <string> title <=> title-text.text;

    close-policy: close-on-click-outside;

    Rectangle {
        width: 100%;
        height: 100%;
        background: #00000080;

        TouchArea {
            clicked => { root.close(); }
        }
    }

    forward-focus: focus-scope;

    focus-scope := FocusScope {
        focus-on-tab-navigation: false;

        key_pressed(event) => {
            if event.text == Key.Escape {
                root.close();
                return accept;
            }

            reject
        }

        Rectangle {
            border-radius: 8px;
            border-width: 1px;
            border-color: #3e3e3e;
            background: #1b1b1b;
            drop-shadow-color: #000000;
            drop-shadow-offset-y: 2px;
            drop-shadow-blur: 4px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: self.preferred-width;
            height: self.preferred-height;
            clip: true;

            TouchArea { // eats clicks, to avoid closing the dialog
                VerticalBox {
                    title-text := Text {
                        horizontal-alignment: center;
                        font-size: 18px;
                    }

                    @children
                }
            }

            close-button := CloseButton {
                x: parent.width - self.width - 8px;
                y: 8px;
                clicked => { root.close(); }
            }

            animate width, height {
                 duration: 200ms;
                 easing: ease-out;
            }
        }
    }
}

component AddWalletSourceDialog inherits Rectangle {
    in-out property <int> wallet-index: -1;
    in-out property <int> step: 0;
    in-out property <string> kind-id: "";
    in-out property <string> kind-label: "";
    in-out property <string> input: "";
    in-out property <string> name: "";

    callback close-requested();
    callback add-csv-requested(int);
    callback add-address-requested(int, string, string, string);

    preferred-height: self.step == 0 ? page-1.preferred-height : page-2.preferred-height;
    min-height: 0px;

    function select-kind(kind_id: string, kind_label: string) {
        root.step = 1;
        root.kind-id = kind_id;
        root.kind-label = kind_label;
        name-input.focus();
    }

    page-1 := GridBox {
        visible: step == 0;
        min-height: 0px;

        Text {
            row: 0; col: 0;
            text: "Import CSV file";
            vertical-alignment: center;
        }
        Button {
            row: 0; col: 1; colspan: 2;
            text: "CSV file";
            clicked => {
                root.add-csv-requested(wallet-index);
                root.close-requested();
            }
        }

        Text {
            row: 2; col: 0;
            text: "Bitcoin";
            vertical-alignment: center;

        }
        Button {
            row: 2; col: 1;
            text: "Bitcoin Address(es)";
            clicked => { root.select-kind("BitcoinAddresses", "Bitcoin Address(es)"); }
        }
        Button {
            row: 2; col: 2;
            text: "Bitcoin HD Wallet(s)";
            clicked => { root.select-kind("BitcoinXpubs", "Bitcoin HD Wallet(s)"); }
        }

        Text {
            row: 3; col: 0;
            text: "Ethereum";
            vertical-alignment: TextVerticalAlignment.center;
        }
        Button {
            row: 3; col: 1; colspan: 2;
            text: "Ethereum Address";
            clicked => { root.select-kind("EthereumAddress", "Ethereum Address"); }
        }

        Text {
            row: 4; col: 0;
            text: "Stellar";
            vertical-alignment: TextVerticalAlignment.center;
        }
        Button {
            row: 4; col: 1; colspan: 2;
            text: "Stellar Account";
            clicked => { root.select-kind("StellarAccount", "Stellar Address"); }
        }
    }

    page-2 := VerticalBox {
        visible: step == 1;

        name-input := LineEdit {
            text <=> root.name;
            placeholder-text: "Name";
        }
        address-input := LineEdit {
            text <=> root.input;
            preferred-width: 300px;
            placeholder-text: {
                if (kind-id == "BitcoinAddresses") {
                    "Address(es), separated by spaces";
                } else if (kind-id == "BitcoinXpubs") {
                    "Extended Public Key(s), separated by spaces";
                } else if (kind-id == "StellarAccount") {
                    "Stellar Account ID";
                } else if (kind-id == "EthereumAddress") {
                    "Ethereum Address";
                } else {
                    "Address";
                }
            }
            accepted => {
                if (self.text != "") {
                    root.add-address-requested(wallet-index, kind-id, self.text, name);
                    root.close-requested();
                }
            }
        }

        Text {
            font-size: 12px;
            color: #666;
            text: {
                if (kind-id == "BitcoinAddresses" || kind-id == "BitcoinXpubs") {
                    "Synced using https://blockstream.info/";
                } else if (kind-id == "StellarAccount") {
                    "Synced using https://horizon.stellar.org/";
                } else if (kind-id == "EthereumAddress") {
                    "Synced using https://etherscan.io/";
                } else {
                    "";
                }
            }
            horizontal-alignment: center;
        }

        Rectangle {}    // bit of space

        HorizontalBox {
            padding: 0;

            Button {
                text: "Back";
                clicked => {
                    root.step = 0;
                    root.input = "";
                    root.name = "";
                }
            }
            Rectangle { horizontal-stretch: 1; }
            Button {
                text: "Add Source";
                enabled: address-input.text != "";
                clicked => {
                    root.add-address-requested(wallet-index, kind-id, address-input.text, name);
                    root.close-requested();
                }
            }
        }
    }
}

component MainContent inherits Rectangle {
    property <Page> active-page: Page.sources;
    property <int> add-source-wallet-index: -1;
    property <int> add-source-step: 0; // 0 = pick type, 1 = enter address
    property <string> add-source-kind-id: "";
    property <string> add-source-kind-label: "";
    property <string> add-source-input: "";
    property <string> add-source-name: "";

    function page-index(page: Page) -> int {
        if (page == Page.portfolio) { 0 }
        else if (page == Page.sources) { 1 }
        else if (page == Page.transactions) { 2 }
        else { 3 }
    }

    function page-offset(page: Page) -> length {
        (page-index(page) - page-index(active-page)) * 50px
    }

    VerticalLayout {
        NavigationBar {
            active-page <=> root.active-page;
        }

        Rectangle {
            Portfolio {
                opacity: active-page == Page.portfolio ? 1 : 0;
                visible: self.opacity > 0;
                x: page-offset(Page.portfolio);
                currency-filter-clicked(currency) => {
                    Facade.set-currency-filter(currency);
                    root.active-page = Page.transactions;
                }
                animate x, opacity { duration: 100ms; }
            }

            Wallets {
                opacity: active-page == Page.sources ? 1 : 0;
                visible: self.opacity > 0;
                x: page-offset(Page.sources);
                wallet-transactions-clicked(index) => {
                    Facade.set-wallet-filter(index);
                    root.active-page = Page.transactions;
                }
                add-source-requested(index) => {
                    root.add-source-wallet-index = index;
                    root.add-source-step = 0;
                    root.add-source-kind-id = "";
                    root.add-source-kind-label = "";
                    root.add-source-input = "";
                    root.add-source-name = "";
                    add-source-modal.show();
                }
                animate x, opacity { duration: 100ms; }
            }

            transactions := Transactions {
                opacity: active-page == Page.transactions ? 1 : 0;
                visible: self.opacity > 0;
                x: page-offset(Page.transactions);
                animate x, opacity { duration: 100ms; }
            }

            Reports {
                opacity: active-page == Page.reports ? 1 : 0;
                visible: self.opacity > 0;
                x: page-offset(Page.reports);
                currency-filter-clicked(currency) => {
                    Facade.set-currency-filter(currency);
                    root.active-page = Page.transactions;
                }
                select-transaction(id) => {
                    transactions.select-transaction(id);
                    root.active-page = Page.transactions;
                }
                animate x, opacity { duration: 100ms; }
            }
        }
    }

    add-source-modal := ModalDialog {
        width: root.width;
        height: root.height;

        title: root.add-source-step == 0 ? "Add Source" : "Add " + root.add-source-kind-label;

        AddWalletSourceDialog {
            wallet-index <=> root.add-source-wallet-index;
            step <=> root.add-source-step;
            kind-id <=> root.add-source-kind-id;
            kind-label <=> root.add-source-kind-label;
            input <=> root.add-source-input;
            name <=> root.add-source-name;

            close-requested() => { add-source-modal.close(); }
            add-csv-requested(wallet_index) => { Facade.add-source-csv(wallet_index); }
            add-address-requested(wallet_index, kind_id, input, name) => {
                Facade.add-source-address(wallet_index, kind_id, input, name);
            }
        }
    }
}

component WelcomePage inherits Rectangle {
    VerticalBox {
        width: Math.min(self.preferred-width, root.width);
        height: Math.min(self.preferred-height, root.height);

        padding-top: 30px;
        padding-bottom: 30px;

        Image {
            source: @image-url("icons/app-icon.svg");
            preferred-width: 192px;
            preferred-height: 192px;
        }
        Text { text: "Raccoin"; horizontal-alignment: center; font-size: 50px; }
        Text { text: "Crypto Portfolio and Tax Reporting Tool"; horizontal-alignment: center; color: darkgray; }

        Rectangle { height: 30px; }

        HorizontalBox {
            Button {
                text: "New Portfolio";
                clicked => { Facade.new-portfolio(); }
            }
            Button {
                text: "Load Portfolio";
                clicked => { Facade.load-portfolio(); }
            }
        }
    }
}

export component AppWindow inherits Window {
    title: "Raccoin";
    icon: @image-url("icons/app-icon-64.png");

    min-width: 512px;
    min-height: 320px;
    preferred-width: 1200px;
    preferred-height: 640px;

    MainContent {
        visible: Facade.portfolio.file-name != "";
    }
    if (Facade.portfolio.file-name == ""): WelcomePage {}

    HorizontalBox {
        alignment: center;
        VerticalBox {
            alignment: end;

            Rectangle { vertical-stretch: 1; }

            for notification[index] in Facade.notifications: Rectangle {
                border-radius: 5px;
                background: notification.notification-type == UiNotificationType.error ? darkred :
                            notification.notification-type == UiNotificationType.warning ? darkorange :
                            notification.notification-type == UiNotificationType.info ? darkblue : darkgreen;
                border-color: notification.notification-type == UiNotificationType.error ? red :
                              notification.notification-type == UiNotificationType.warning ? orange :
                              notification.notification-type == UiNotificationType.info ? blue : green;
                border-width: 1px;

                HorizontalBox {
                    padding-left: 10px;
                    spacing: 10px;
                    Text {
                        text: notification.message;
                        horizontal-stretch: 1;
                        vertical-alignment: center;
                        color: white;
                    }
                    Button {
                        icon: @image-url("icons/x.svg");
                        clicked => { Facade.remove-notification(index); }
                    }
                }
            }
        }
    }
}
